dist: trusty
sudo: required

language: c
python: 3

compiler:
  - gcc
  - clang

addons:
  apt:
    packages:
      - valgrind
      - cloc
      - python3-pip

install:
  - travis_retry wget https://cmake.org/files/v3.12/cmake-3.12.4-Linux-x86_64.sh
  - sudo bash cmake-3.12.4-Linux-x86_64.sh --skip-license --exclude-subdir --prefix=/usr/local
  - export PATH="/usr/local/bin:$PATH"
  - pip3 uninstall setuptools
  - pip3 install setuptools
  - pip3 install protobuf grpcio-tools

before_script:
  - ${CC} --version
  - cmake --version
  - valgrind --version

script:
  - cmake -H. -Bbuild
      -DENABLE_HEAVY_TESTS=OFF
      -DVIRGIL_C_MT_TESTING=OFF
      -DENABLE_BENCHMARKING=ON
      -DVIRGIL_POST_QUANTUM=ON
      -DVIRGIL_PROGRAMS=ON
  - cmake --build build -- -j8
    && pushd build
    && ctest -T memcheck --output-on-failure
    && popd
  - cmake -H. -Bbuild -DVIRGIL_C_MT_TESTING=ON
  - cmake --build build -- -j8
    && pushd build
    && ctest -L multi-threading --output-on-failure
    && ./benchmarks/foundation/bench
    && popd
  - cat build/Testing/Temporary/MemoryChecker.*.log

after_success:
  - cmake --build build --target cloc
